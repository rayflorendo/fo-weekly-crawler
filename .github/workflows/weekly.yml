# .github/workflows/weekly.yml
name: weekly-crawl

on:
  schedule:
    - cron: '0 18 * * 5'   # JST åœŸæ›œ 03:00 ã«è‡ªå‹•å®Ÿè¡Œ
  workflow_dispatch:
    inputs:
      slack_user_id:
        description: "Requester Slack user ID (for DM)"
        required: false
        type: string

permissions:
  contents: write

jobs:
  crawl:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: pip install -r requirements.txt

      - name: Run scraper
        run: python scrape.py

      - name: Commit & push if changed
        shell: bash
        run: |
          set -e
          git config user.name "auto-bot"
          git config user.email "bot@example.com"
          git add docs/data.json docs/data.jsonl || true
          if git diff --cached --quiet; then
            echo "no changes"
          else
            git commit -m "chore: weekly data.json update"
            git push
          fi

      # WorkerçµŒç”±ã®æ‰‹å‹•å®Ÿè¡Œæ™‚ã®ã¿ã€å®Ÿè¡Œè€…ã¸DMã§ãƒ•ã‚¡ã‚¤ãƒ«é€ä»˜
      - name: DM file to requester
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.slack_user_id != '' }}
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_USER_ID: ${{ github.event.inputs.slack_user_id }}
        shell: bash
        run: |
          set -e

          if [ ! -f docs/data.json ]; then
            echo "docs/data.json not found"; exit 1
          fi

          # DMç”¨ã®IMãƒãƒ£ãƒãƒ«ã‚’é–‹ã
          OPEN_JSON="$(curl -sS -X POST https://slack.com/api/conversations.open \
            -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            -H "Content-Type: application/json; charset=utf-8" \
            -d "{\"users\":\"$SLACK_USER_ID\"}")"

          # jqãŒç„¡ã„ç’°å¢ƒã‚‚ã‚ã‚‹ã®ã§pythonã§æŠ½å‡º
          IM_CHANNEL="$(echo "$OPEN_JSON" | python - <<'PY'
import sys, json
data = json.load(sys.stdin)
print(data.get("channel", {}).get("id", ""))
PY
)"
          if [ -z "$IM_CHANNEL" ]; then
            echo "Failed to open DM channel: $OPEN_JSON"
            exit 1
          fi

          # ãƒ•ã‚¡ã‚¤ãƒ«ã‚’DMã«æ·»ä»˜ + å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
          curl -sS -F "channels=$IM_CHANNEL" \
               -F "initial_comment=ãŠå¾…ãŸã›ã—ã¾ã—ãŸï¼æœ€æ–°ã®GPTsç”¨ãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ğŸ‰" \
               -F "file=@docs/data.json" \
               -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
               https://slack.com/api/files.upload
